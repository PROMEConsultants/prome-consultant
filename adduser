<?php
session_start();

if (!isset($_SESSION['logged_in']) || !$_SESSION['logged_in']) {
    header('Location: forms.html');
    exit();
}

// Database connection details
$servername = "localhost";
$username = "root"; // Default username for XAMPP
$password = ""; // Default password for XAMPP
$dbname = "formsdb";

// Create connection
$conn = new mysqli($servername, $username, $password, $dbname);

// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Fetch PDF metadata from the database
$available_sql = "SELECT id, filename, filepath FROM pdfs";
$available_result = $conn->query($available_sql);

if (!$available_result) {
    die("Query failed: " . $conn->error);
}

// Fetch approved forms metadata from the database
$approved_sql = "SELECT filename, filepath, timestamp FROM approved_forms WHERE status='approved' ORDER BY timestamp DESC";
$approved_result = $conn->query($approved_sql);

if (!$approved_result) {
    die("Query failed: " . $conn->error);
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Prome Consultants Pdfs</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        .container {
            width: 80%;
            margin: auto;
        }
        .form-section {
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .box {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Prome Consultants Forms</h1>

        <div class="content">
            <!-- Available Forms Section -->
            <div class="box">
                <h2>Available Forms</h2>
                <?php
                if ($available_result->num_rows > 0) {
                    while ($row = $available_result->fetch_assoc()) {
                        echo "<div>";
                        echo "<h3>" . htmlspecialchars($row["filename"]) . "</h3>";
                        echo "<a href='download.php?file=" . urlencode($row["filename"]) . "'>Download " . htmlspecialchars($row["filename"]) . "</a>";
                        echo "</div><hr>";
                    }
                } else {
                    echo "No PDFs available.";
                }
                ?>
            </div>

            <!-- Approved Forms Section -->
            <div class="box">
                <h2>Approved Forms</h2>
                <?php if ($approved_result->num_rows > 0): ?>
                    <table>
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Download Link</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php while ($row = $approved_result->fetch_assoc()): ?>
                                <tr>
                                    <td><?php echo htmlspecialchars($row["filename"]); ?></td>
                                    <td><a href="<?php echo htmlspecialchars($row["filepath"]); ?>" target="_blank">View</a></td>
                                    <td><?php echo htmlspecialchars($row["timestamp"]); ?></td>
                                </tr>
                            <?php endwhile; ?>
                        </tbody>
                    </table>
                <?php else: ?>
                    <p>No approved forms available.</p>
                <?php endif; ?>
            </div>
        </div>
    
        <div class="image-capture-section">

    <h2>Upload Scanned Form</h2>
   
    <form  method="post" enctype="multipart/form-data">
    <label for="fileToUpload">Capture or Select a File:</label>
    <input type="file" name="fileToUpload" id="doc" accept="image/*;capture=camera">
    <input type="submit" value="Upload Scanned Form" name="submit">

    </form>

</div>


<?php
if (isset($_POST['submit'])) {  // Match 'submit' exactly
    // File Handling
    $file = $_FILES['fileToUpload'];
    $games_image = $file['name'];
    $games_tmp = $file['tmp_name'];

    // Error handling: Check if the file was uploaded
    if ($file['error'] !== UPLOAD_ERR_OK) {
        die("Upload failed with error code " . $file['error']);
    }

    // Get file extension and create a new file name
    $extension = pathinfo($games_image, PATHINFO_EXTENSION);
    $fileName = pathinfo($games_image, PATHINFO_FILENAME) . '.' . $extension;

    // Move the uploaded file to the 'documents' directory
    if (move_uploaded_file($games_tmp, "documents/$fileName")) {
        echo "File uploaded successfully!";
    } else {
        die("Failed to move uploaded file.");
    }

    // SQL Insertion
    $timestamp = date('Y-m-d H:i:s'); // Add current timestamp
    $filepath = "documents/$fileName"; // Define the filepath
    $status = 'Pending'; // Default status
    
    $sql = "INSERT INTO `approved_forms` (`id`, `filename`, `filepath`, `timestamp`, `status`) VALUES (NULL, '$fileName', '$filepath', '$timestamp', '$status')";

    // Error handling: Check if the query is successful
    if (mysqli_query($conn, $sql)) {
        echo "Record inserted successfully!";
        ?>
        <script type="text/javascript" language="javascript">
            window.location = "protected.php";
        </script>
        <?php
    } else {
        die("Error inserting record: " . mysqli_error($conn));
    }
}
?>



<script>
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const uploadButton = document.getElementById('upload-button');

fileInput.addEventListener('change', () => {
    const file = fileInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            imagePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});
uploadButton.addEventListener('click', () => {
    const file = fileInput.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('scanned_form', file);


fetch('upload.php', {
    method: 'POST',
    body: formData
})
.then(response => response.text())
.then(result => {
    alert(result);
})
.catch(error => {
    console.error('Error:', error);
});
} else {
alert('Please select a file.');
}
});
</script>
</body>
</html>




        <a href="logout.php">Logout</a>
    </div>
</body>
</html>
<?
$conn->close();
?>
newwwwwwwww <code>
/*
Theme Name: Twenty Twenty-Four
Theme URI: https://wordpress.org/themes/twentytwentyfour/
Author: the WordPress team
Author URI: https://wordpress.org
Description: Twenty Twenty-Four is designed to be flexible, versatile and applicable to any website. Its collection of templates and patterns tailor to different needs, such as presenting a business, blogging and writing or showcasing work. A multitude of possibilities open up with just a few adjustments to color and typography. Twenty Twenty-Four comes with style variations and full page designs to help speed up the site building process, is fully compatible with the site editor, and takes advantage of new design tools introduced in WordPress 6.4.
Requires at least: 6.4
Tested up to: 6.6
Requires PHP: 7.0
Version: 1.2
License: GNU General Public License v2 or later
License URI: http://www.gnu.org/licenses/gpl-2.0.html
Text Domain: twentytwentyfour
Tags: one-column, custom-colors, custom-menu, custom-logo, editor-style, featured-images, full-site-editing, block-patterns, rtl-language-support, sticky-post, threaded-comments, translation-ready, wide-blocks, block-styles, style-variations, accessibility-ready, blog, portfolio, news
*/
<?php
get_header();
session_start();

// Redirect if not logged in
if (!isset($_SESSION['logged_in']) || !$_SESSION['logged_in']) {
    header('Location: forms.html');
    exit();
}

// Database connection details
$servername = "localhost";
$username = "root"; 
$password = ""; 
$dbname = "formsdb";

$conn = new mysqli($servername, $username, $password, $dbname);

// Check connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Fetch available PDFs
$available_sql = "SELECT id, filename, filepath FROM pdfs";
$available_result = $conn->query($available_sql);

// Fetch approved forms
$approved_sql = "SELECT filename, filepath, timestamp FROM approved_forms WHERE status='approved' ORDER BY timestamp DESC";
$approved_result = $conn->query($approved_sql);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prome Consultants Forms</title>
    <link rel="stylesheet" type="text/css" href="<?php echo get_stylesheet_directory_uri(); ?>/styles.css">
</head>
<body>
    <div class="container">
        <h1>Prome Consultants Forms</h1>

        <div class="content">
            <div class="box">
                <h2>Available Forms</h2>
                <?php if ($available_result->num_rows > 0): ?>
                    <?php while ($row = $available_result->fetch_assoc()): ?>
                        <div>
                            <h3><?php echo htmlspecialchars($row["filename"]); ?></h3>
                            <a href="download.php?file=<?php echo urlencode($row["filename"]); ?>">Download <?php echo htmlspecialchars($row["filename"]); ?></a>
                        </div>
                        <hr>
                    <?php endwhile; ?>
                <?php else: ?>
                    <p>No PDFs available.</p>
                <?php endif; ?>
            </div>

            <div class="box">
                <h2>Approved Forms</h2>
                <?php if ($approved_result->num_rows > 0): ?>
                    <table>
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Download Link</th>
                                <th>Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php while ($row = $approved_result->fetch_assoc()): ?>
                                <tr>
                                    <td><?php echo htmlspecialchars($row["filename"]); ?></td>
                                    <td><a href="<?php echo htmlspecialchars($row["filepath"]); ?>" target="_blank">View</a></td>
                                    <td><?php echo htmlspecialchars($row["timestamp"]); ?></td>
                                </tr>
                            <?php endwhile; ?>
                        </tbody>
                    </table>
                <?php else: ?>
                    <p>No approved forms available.</p>
                <?php endif; ?>
            </div>
        </div>

        <div class="image-capture-section">
            <h2>Upload Scanned Form</h2>
            <form method="post" enctype="multipart/form-data">
                <label for="fileToUpload">Capture or Select a File:</label>
                <input type="file" name="fileToUpload" id="fileToUpload" accept="image/*;capture=camera">
                <input type="submit" value="Upload Scanned Form" name="submit">
            </form>
        </div>

        <?php
        // Handle file upload
        if (isset($_POST['submit'])) {
            $file = $_FILES['fileToUpload'];

            // Check for upload errors
            if ($file['error'] !== UPLOAD_ERR_OK) {
                die("Upload failed with error code " . $file['error']);
            }

            $fileName = basename($file['name']);
            $filePath = "documents/" . $fileName;

            // Move the uploaded file
            if (move_uploaded_file($file['tmp_name'], $filePath)) {
                echo "File uploaded successfully!";
            } else {
                die("Failed to move uploaded file.");
            }

            // Insert into database
            $timestamp = date('Y-m-d H:i:s');
            $sql = "INSERT INTO approved_forms (filename, filepath, timestamp, status) VALUES ('$fileName', '$filePath', '$timestamp', 'approved')";

            if (mysqli_query($conn, $sql)) {
                echo "Record inserted successfully!";
            } else {
                die("Error inserting record: " . mysqli_error($conn));
            }
        }
        ?>

        <a href="logout.php">Logout</a>
    </div>
</body>
</html>

<?php
get_footer(); // Include the footer (if needed)
?>
</code>